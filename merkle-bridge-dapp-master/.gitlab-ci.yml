# 1. Define the stages in order of execution
stages:
  - build
  - test
  - publish # We'll need this stage for the final push

# 2. Define the Docker environment variables (required for 'docker in docker')
variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  # Set the final image name using built-in GitLab variables
  IMAGE_NAME: $CI_REGISTRY/$CI_PROJECT_PATH/my-app

# --- JOB 1: Build the Docker Image ---
build-image:
  stage: build
  image: docker:20.10.16 # Use a Docker client image
  services:
    - docker:20.10.16-dind # Required to run Docker commands
  script:
    - echo "--- Building Docker Image ---"
    # Build the image using the current commit SHA as a unique tag
    # The '.' indicates the Dockerfile is in the root directory
    - docker build -t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
    # Tag the image with 'test-latest' for the next stage's immediate use
    - docker tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA $IMAGE_NAME:test-latest
  # Allow the 'test' job to access the built image
  needs: []

# --- JOB 2: Run Unit Tests ---
# This job ensures the code *inside* the image is functional
run-tests:
  stage: test
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  script:
    - echo "--- Pulling Image from Build Stage ---"
    # We must log in to pull the image even though it's local (security requirement)
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    
    - echo "--- Running Unit Tests inside Container ---"
    # Run the tests defined inside the container using the image built in Job 1
    # If this command fails, the pipeline STOPS.
    # ***IMPORTANT: Replace 'npm test' with your actual test command***
    - docker run $IMAGE_NAME:test-latest npm test 

# --- JOB 3 (Placeholder): Publish the Image to Registry ---
# This stage is the final part of your original request. 
# We will leave this simple for now and enhance it once testing is successful.
publish-image:
  stage: publish
  script:
    - echo "Publish stage placeholder - Ready to push image!"
  # Ensure this only runs if previous stages succeed
  when: on_success